{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { SentryError, supportsReferrerPolicy, SyncPromise } from '@sentry/utils';\nimport { BaseTransport } from './base';\nimport { getNativeFetchImplementation } from './utils';\n/** `fetch` based transport */\nvar FetchTransport = /** @class */function (_super) {\n  __extends(FetchTransport, _super);\n  function FetchTransport(options, fetchImpl) {\n    if (fetchImpl === void 0) {\n      fetchImpl = getNativeFetchImplementation();\n    }\n    var _this = _super.call(this, options) || this;\n    _this._fetch = fetchImpl;\n    return _this;\n  }\n  /**\n   * @param sentryRequest Prepared SentryRequest to be delivered\n   * @param originalPayload Original payload used to create SentryRequest\n   */\n  FetchTransport.prototype._sendRequest = function (sentryRequest, originalPayload) {\n    var _this = this;\n    // eslint-disable-next-line deprecation/deprecation\n    if (this._isRateLimited(sentryRequest.type)) {\n      this.recordLostEvent('ratelimit_backoff', sentryRequest.type);\n      return Promise.reject({\n        event: originalPayload,\n        type: sentryRequest.type,\n        // eslint-disable-next-line deprecation/deprecation\n        reason: \"Transport for \" + sentryRequest.type + \" requests locked till \" + this._disabledUntil(sentryRequest.type) + \" due to too many requests.\",\n        status: 429\n      });\n    }\n    var options = {\n      body: sentryRequest.body,\n      method: 'POST',\n      // Despite all stars in the sky saying that Edge supports old draft syntax, aka 'never', 'always', 'origin' and 'default'\n      // (see https://caniuse.com/#feat=referrer-policy),\n      // it doesn't. And it throws an exception instead of ignoring this parameter...\n      // REF: https://github.com/getsentry/raven-js/issues/1233\n      referrerPolicy: supportsReferrerPolicy() ? 'origin' : ''\n    };\n    if (this.options.fetchParameters !== undefined) {\n      Object.assign(options, this.options.fetchParameters);\n    }\n    if (this.options.headers !== undefined) {\n      options.headers = this.options.headers;\n    }\n    return this._buffer.add(function () {\n      return new SyncPromise(function (resolve, reject) {\n        void _this._fetch(sentryRequest.url, options).then(function (response) {\n          var headers = {\n            'x-sentry-rate-limits': response.headers.get('X-Sentry-Rate-Limits'),\n            'retry-after': response.headers.get('Retry-After')\n          };\n          _this._handleResponse({\n            requestType: sentryRequest.type,\n            response: response,\n            headers: headers,\n            resolve: resolve,\n            reject: reject\n          });\n        }).catch(reject);\n      });\n    }).then(undefined, function (reason) {\n      // It's either buffer rejection or any other xhr/fetch error, which are treated as NetworkError.\n      if (reason instanceof SentryError) {\n        _this.recordLostEvent('queue_overflow', sentryRequest.type);\n      } else {\n        _this.recordLostEvent('network_error', sentryRequest.type);\n      }\n      throw reason;\n    });\n  };\n  return FetchTransport;\n}(BaseTransport);\nexport { FetchTransport };","map":{"version":3,"names":["SentryError","supportsReferrerPolicy","SyncPromise","BaseTransport","getNativeFetchImplementation","FetchTransport","_super","__extends","options","fetchImpl","_this","call","_fetch","prototype","_sendRequest","sentryRequest","originalPayload","_isRateLimited","type","recordLostEvent","Promise","reject","event","reason","_disabledUntil","status","body","method","referrerPolicy","fetchParameters","undefined","Object","assign","headers","_buffer","add","resolve","url","then","response","get","_handleResponse","requestType","catch"],"sources":["../../../../src/transports/fetch.ts"],"sourcesContent":["import { Event, Response, SentryRequest, Session, TransportOptions } from '@sentry/types';\nimport { SentryError, supportsReferrerPolicy, SyncPromise } from '@sentry/utils';\n\nimport { BaseTransport } from './base';\nimport { FetchImpl, getNativeFetchImplementation } from './utils';\n\n/** `fetch` based transport */\nexport class FetchTransport extends BaseTransport {\n  /**\n   * Fetch API reference which always points to native browser implementation.\n   */\n  private _fetch: typeof fetch;\n\n  public constructor(options: TransportOptions, fetchImpl: FetchImpl = getNativeFetchImplementation()) {\n    super(options);\n    this._fetch = fetchImpl;\n  }\n\n  /**\n   * @param sentryRequest Prepared SentryRequest to be delivered\n   * @param originalPayload Original payload used to create SentryRequest\n   */\n  protected _sendRequest(sentryRequest: SentryRequest, originalPayload: Event | Session): PromiseLike<Response> {\n    // eslint-disable-next-line deprecation/deprecation\n    if (this._isRateLimited(sentryRequest.type)) {\n      this.recordLostEvent('ratelimit_backoff', sentryRequest.type);\n\n      return Promise.reject({\n        event: originalPayload,\n        type: sentryRequest.type,\n        // eslint-disable-next-line deprecation/deprecation\n        reason: `Transport for ${sentryRequest.type} requests locked till ${this._disabledUntil(\n          sentryRequest.type,\n        )} due to too many requests.`,\n        status: 429,\n      });\n    }\n\n    const options: RequestInit = {\n      body: sentryRequest.body,\n      method: 'POST',\n      // Despite all stars in the sky saying that Edge supports old draft syntax, aka 'never', 'always', 'origin' and 'default'\n      // (see https://caniuse.com/#feat=referrer-policy),\n      // it doesn't. And it throws an exception instead of ignoring this parameter...\n      // REF: https://github.com/getsentry/raven-js/issues/1233\n      referrerPolicy: (supportsReferrerPolicy() ? 'origin' : '') as ReferrerPolicy,\n    };\n    if (this.options.fetchParameters !== undefined) {\n      Object.assign(options, this.options.fetchParameters);\n    }\n    if (this.options.headers !== undefined) {\n      options.headers = this.options.headers;\n    }\n\n    return this._buffer\n      .add(\n        () =>\n          new SyncPromise<Response>((resolve, reject) => {\n            void this._fetch(sentryRequest.url, options)\n              .then(response => {\n                const headers = {\n                  'x-sentry-rate-limits': response.headers.get('X-Sentry-Rate-Limits'),\n                  'retry-after': response.headers.get('Retry-After'),\n                };\n                this._handleResponse({\n                  requestType: sentryRequest.type,\n                  response,\n                  headers,\n                  resolve,\n                  reject,\n                });\n              })\n              .catch(reject);\n          }),\n      )\n      .then(undefined, reason => {\n        // It's either buffer rejection or any other xhr/fetch error, which are treated as NetworkError.\n        if (reason instanceof SentryError) {\n          this.recordLostEvent('queue_overflow', sentryRequest.type);\n        } else {\n          this.recordLostEvent('network_error', sentryRequest.type);\n        }\n        throw reason;\n      });\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}