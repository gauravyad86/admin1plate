{"ast":null,"code":"/* eslint-disable @typescript-eslint/explicit-function-return-type */\n/* eslint-disable @typescript-eslint/typedef */\n/* eslint-disable @typescript-eslint/explicit-module-boundary-types */\n/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { isThenable } from './is';\n/**\n * Creates a resolved sync promise.\n *\n * @param value the value to resolve the promise with\n * @returns the resolved sync promise\n */\nexport function resolvedSyncPromise(value) {\n  return new SyncPromise(function (resolve) {\n    resolve(value);\n  });\n}\n/**\n * Creates a rejected sync promise.\n *\n * @param value the value to reject the promise with\n * @returns the rejected sync promise\n */\nexport function rejectedSyncPromise(reason) {\n  return new SyncPromise(function (_, reject) {\n    reject(reason);\n  });\n}\n/**\n * Thenable class that behaves like a Promise and follows it's interface\n * but is not async internally\n */\nvar SyncPromise = /** @class */function () {\n  function SyncPromise(executor) {\n    var _this = this;\n    this._state = 0 /* PENDING */;\n    this._handlers = [];\n    /** JSDoc */\n    this._resolve = function (value) {\n      _this._setResult(1 /* RESOLVED */, value);\n    };\n    /** JSDoc */\n    this._reject = function (reason) {\n      _this._setResult(2 /* REJECTED */, reason);\n    };\n    /** JSDoc */\n    this._setResult = function (state, value) {\n      if (_this._state !== 0 /* PENDING */) {\n        return;\n      }\n      if (isThenable(value)) {\n        void value.then(_this._resolve, _this._reject);\n        return;\n      }\n      _this._state = state;\n      _this._value = value;\n      _this._executeHandlers();\n    };\n    /** JSDoc */\n    this._executeHandlers = function () {\n      if (_this._state === 0 /* PENDING */) {\n        return;\n      }\n      var cachedHandlers = _this._handlers.slice();\n      _this._handlers = [];\n      cachedHandlers.forEach(function (handler) {\n        if (handler[0]) {\n          return;\n        }\n        if (_this._state === 1 /* RESOLVED */) {\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\n          handler[1](_this._value);\n        }\n        if (_this._state === 2 /* REJECTED */) {\n          handler[2](_this._value);\n        }\n        handler[0] = true;\n      });\n    };\n    try {\n      executor(this._resolve, this._reject);\n    } catch (e) {\n      this._reject(e);\n    }\n  }\n  /** JSDoc */\n  SyncPromise.prototype.then = function (onfulfilled, onrejected) {\n    var _this = this;\n    return new SyncPromise(function (resolve, reject) {\n      _this._handlers.push([false, function (result) {\n        if (!onfulfilled) {\n          // TODO: ¯\\_(ツ)_/¯\n          // TODO: FIXME\n          resolve(result);\n        } else {\n          try {\n            resolve(onfulfilled(result));\n          } catch (e) {\n            reject(e);\n          }\n        }\n      }, function (reason) {\n        if (!onrejected) {\n          reject(reason);\n        } else {\n          try {\n            resolve(onrejected(reason));\n          } catch (e) {\n            reject(e);\n          }\n        }\n      }]);\n      _this._executeHandlers();\n    });\n  };\n  /** JSDoc */\n  SyncPromise.prototype.catch = function (onrejected) {\n    return this.then(function (val) {\n      return val;\n    }, onrejected);\n  };\n  /** JSDoc */\n  SyncPromise.prototype.finally = function (onfinally) {\n    var _this = this;\n    return new SyncPromise(function (resolve, reject) {\n      var val;\n      var isRejected;\n      return _this.then(function (value) {\n        isRejected = false;\n        val = value;\n        if (onfinally) {\n          onfinally();\n        }\n      }, function (reason) {\n        isRejected = true;\n        val = reason;\n        if (onfinally) {\n          onfinally();\n        }\n      }).then(function () {\n        if (isRejected) {\n          reject(val);\n          return;\n        }\n        resolve(val);\n      });\n    });\n  };\n  return SyncPromise;\n}();\nexport { SyncPromise };","map":{"version":3,"names":["isThenable","resolvedSyncPromise","value","SyncPromise","resolve","rejectedSyncPromise","reason","_","reject","executor","_this","_state","_handlers","_resolve","_setResult","_reject","state","then","_value","_executeHandlers","cachedHandlers","slice","forEach","handler","e","prototype","onfulfilled","onrejected","push","result","catch","val","finally","onfinally","isRejected"],"sources":["../../src/syncpromise.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/explicit-function-return-type */\n/* eslint-disable @typescript-eslint/typedef */\n/* eslint-disable @typescript-eslint/explicit-module-boundary-types */\n/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { isThenable } from './is';\n\n/** SyncPromise internal states */\nconst enum States {\n  /** Pending */\n  PENDING = 0,\n  /** Resolved / OK */\n  RESOLVED = 1,\n  /** Rejected / Error */\n  REJECTED = 2,\n}\n\n/**\n * Creates a resolved sync promise.\n *\n * @param value the value to resolve the promise with\n * @returns the resolved sync promise\n */\nexport function resolvedSyncPromise<T>(value: T | PromiseLike<T>): PromiseLike<T> {\n  return new SyncPromise(resolve => {\n    resolve(value);\n  });\n}\n\n/**\n * Creates a rejected sync promise.\n *\n * @param value the value to reject the promise with\n * @returns the rejected sync promise\n */\nexport function rejectedSyncPromise<T = never>(reason?: any): PromiseLike<T> {\n  return new SyncPromise((_, reject) => {\n    reject(reason);\n  });\n}\n\n/**\n * Thenable class that behaves like a Promise and follows it's interface\n * but is not async internally\n */\nclass SyncPromise<T> implements PromiseLike<T> {\n  private _state: States = States.PENDING;\n  private _handlers: Array<[boolean, (value: T) => void, (reason: any) => any]> = [];\n  private _value: any;\n\n  public constructor(\n    executor: (resolve: (value?: T | PromiseLike<T> | null) => void, reject: (reason?: any) => void) => void,\n  ) {\n    try {\n      executor(this._resolve, this._reject);\n    } catch (e) {\n      this._reject(e);\n    }\n  }\n\n  /** JSDoc */\n  public then<TResult1 = T, TResult2 = never>(\n    onfulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | null,\n    onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | null,\n  ): PromiseLike<TResult1 | TResult2> {\n    return new SyncPromise((resolve, reject) => {\n      this._handlers.push([\n        false,\n        result => {\n          if (!onfulfilled) {\n            // TODO: ¯\\_(ツ)_/¯\n            // TODO: FIXME\n            resolve(result as any);\n          } else {\n            try {\n              resolve(onfulfilled(result));\n            } catch (e) {\n              reject(e);\n            }\n          }\n        },\n        reason => {\n          if (!onrejected) {\n            reject(reason);\n          } else {\n            try {\n              resolve(onrejected(reason));\n            } catch (e) {\n              reject(e);\n            }\n          }\n        },\n      ]);\n      this._executeHandlers();\n    });\n  }\n\n  /** JSDoc */\n  public catch<TResult = never>(\n    onrejected?: ((reason: any) => TResult | PromiseLike<TResult>) | null,\n  ): PromiseLike<T | TResult> {\n    return this.then(val => val, onrejected);\n  }\n\n  /** JSDoc */\n  public finally<TResult>(onfinally?: (() => void) | null): PromiseLike<TResult> {\n    return new SyncPromise<TResult>((resolve, reject) => {\n      let val: TResult | any;\n      let isRejected: boolean;\n\n      return this.then(\n        value => {\n          isRejected = false;\n          val = value;\n          if (onfinally) {\n            onfinally();\n          }\n        },\n        reason => {\n          isRejected = true;\n          val = reason;\n          if (onfinally) {\n            onfinally();\n          }\n        },\n      ).then(() => {\n        if (isRejected) {\n          reject(val);\n          return;\n        }\n\n        resolve(val as unknown as any);\n      });\n    });\n  }\n\n  /** JSDoc */\n  private readonly _resolve = (value?: T | PromiseLike<T> | null) => {\n    this._setResult(States.RESOLVED, value);\n  };\n\n  /** JSDoc */\n  private readonly _reject = (reason?: any) => {\n    this._setResult(States.REJECTED, reason);\n  };\n\n  /** JSDoc */\n  private readonly _setResult = (state: States, value?: T | PromiseLike<T> | any) => {\n    if (this._state !== States.PENDING) {\n      return;\n    }\n\n    if (isThenable(value)) {\n      void (value as PromiseLike<T>).then(this._resolve, this._reject);\n      return;\n    }\n\n    this._state = state;\n    this._value = value;\n\n    this._executeHandlers();\n  };\n\n  /** JSDoc */\n  private readonly _executeHandlers = () => {\n    if (this._state === States.PENDING) {\n      return;\n    }\n\n    const cachedHandlers = this._handlers.slice();\n    this._handlers = [];\n\n    cachedHandlers.forEach(handler => {\n      if (handler[0]) {\n        return;\n      }\n\n      if (this._state === States.RESOLVED) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\n        handler[1](this._value as unknown as any);\n      }\n\n      if (this._state === States.REJECTED) {\n        handler[2](this._value);\n      }\n\n      handler[0] = true;\n    });\n  };\n}\n\nexport { SyncPromise };\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA,SAASA,UAAU,QAAQ,MAAM;AAYjC;;;;;;AAMA,OAAM,SAAUC,mBAAmBA,CAAIC,KAAyB;EAC9D,OAAO,IAAIC,WAAW,CAAC,UAAAC,OAAO;IAC5BA,OAAO,CAACF,KAAK,CAAC;EAChB,CAAC,CAAC;AACJ;AAEA;;;;;;AAMA,OAAM,SAAUG,mBAAmBA,CAAYC,MAAY;EACzD,OAAO,IAAIH,WAAW,CAAC,UAACI,CAAC,EAAEC,MAAM;IAC/BA,MAAM,CAACF,MAAM,CAAC;EAChB,CAAC,CAAC;AACJ;AAEA;;;;AAIA,IAAAH,WAAA;EAKE,SAAAA,YACEM,QAAwG;IAD1G,IAAAC,KAAA;IAJQ,KAAAC,MAAM;IACN,KAAAC,SAAS,GAA+D,EAAE;IAyFlF;IACiB,KAAAC,QAAQ,GAAG,UAACX,KAAiC;MAC5DQ,KAAI,CAACI,UAAU,mBAAkBZ,KAAK,CAAC;IACzC,CAAC;IAED;IACiB,KAAAa,OAAO,GAAG,UAACT,MAAY;MACtCI,KAAI,CAACI,UAAU,mBAAkBR,MAAM,CAAC;IAC1C,CAAC;IAED;IACiB,KAAAQ,UAAU,GAAG,UAACE,KAAa,EAAEd,KAAgC;MAC5E,IAAIQ,KAAI,CAACC,MAAM,sBAAqB;QAClC;;MAGF,IAAIX,UAAU,CAACE,KAAK,CAAC,EAAE;QACrB,KAAMA,KAAwB,CAACe,IAAI,CAACP,KAAI,CAACG,QAAQ,EAAEH,KAAI,CAACK,OAAO,CAAC;QAChE;;MAGFL,KAAI,CAACC,MAAM,GAAGK,KAAK;MACnBN,KAAI,CAACQ,MAAM,GAAGhB,KAAK;MAEnBQ,KAAI,CAACS,gBAAgB,EAAE;IACzB,CAAC;IAED;IACiB,KAAAA,gBAAgB,GAAG;MAClC,IAAIT,KAAI,CAACC,MAAM,sBAAqB;QAClC;;MAGF,IAAMS,cAAc,GAAGV,KAAI,CAACE,SAAS,CAACS,KAAK,EAAE;MAC7CX,KAAI,CAACE,SAAS,GAAG,EAAE;MAEnBQ,cAAc,CAACE,OAAO,CAAC,UAAAC,OAAO;QAC5B,IAAIA,OAAO,CAAC,CAAC,CAAC,EAAE;UACd;;QAGF,IAAIb,KAAI,CAACC,MAAM,uBAAsB;UACnC;UACAY,OAAO,CAAC,CAAC,CAAC,CAACb,KAAI,CAACQ,MAAwB,CAAC;;QAG3C,IAAIR,KAAI,CAACC,MAAM,uBAAsB;UACnCY,OAAO,CAAC,CAAC,CAAC,CAACb,KAAI,CAACQ,MAAM,CAAC;;QAGzBK,OAAO,CAAC,CAAC,CAAC,GAAG,IAAI;MACnB,CAAC,CAAC;IACJ,CAAC;IAvIC,IAAI;MACFd,QAAQ,CAAC,IAAI,CAACI,QAAQ,EAAE,IAAI,CAACE,OAAO,CAAC;KACtC,CAAC,OAAOS,CAAC,EAAE;MACV,IAAI,CAACT,OAAO,CAACS,CAAC,CAAC;;EAEnB;EAEA;EACOrB,WAAA,CAAAsB,SAAA,CAAAR,IAAI,GAAX,UACES,WAAqE,EACrEC,UAAuE;IAFzE,IAAAjB,KAAA;IAIE,OAAO,IAAIP,WAAW,CAAC,UAACC,OAAO,EAAEI,MAAM;MACrCE,KAAI,CAACE,SAAS,CAACgB,IAAI,CAAC,CAClB,KAAK,EACL,UAAAC,MAAM;QACJ,IAAI,CAACH,WAAW,EAAE;UAChB;UACA;UACAtB,OAAO,CAACyB,MAAa,CAAC;SACvB,MAAM;UACL,IAAI;YACFzB,OAAO,CAACsB,WAAW,CAACG,MAAM,CAAC,CAAC;WAC7B,CAAC,OAAOL,CAAC,EAAE;YACVhB,MAAM,CAACgB,CAAC,CAAC;;;MAGf,CAAC,EACD,UAAAlB,MAAM;QACJ,IAAI,CAACqB,UAAU,EAAE;UACfnB,MAAM,CAACF,MAAM,CAAC;SACf,MAAM;UACL,IAAI;YACFF,OAAO,CAACuB,UAAU,CAACrB,MAAM,CAAC,CAAC;WAC5B,CAAC,OAAOkB,CAAC,EAAE;YACVhB,MAAM,CAACgB,CAAC,CAAC;;;MAGf,CAAC,CACF,CAAC;MACFd,KAAI,CAACS,gBAAgB,EAAE;IACzB,CAAC,CAAC;EACJ,CAAC;EAED;EACOhB,WAAA,CAAAsB,SAAA,CAAAK,KAAK,GAAZ,UACEH,UAAqE;IAErE,OAAO,IAAI,CAACV,IAAI,CAAC,UAAAc,GAAG;MAAI,OAAAA,GAAG;IAAH,CAAG,EAAEJ,UAAU,CAAC;EAC1C,CAAC;EAED;EACOxB,WAAA,CAAAsB,SAAA,CAAAO,OAAO,GAAd,UAAwBC,SAA+B;IAAvD,IAAAvB,KAAA;IACE,OAAO,IAAIP,WAAW,CAAU,UAACC,OAAO,EAAEI,MAAM;MAC9C,IAAIuB,GAAkB;MACtB,IAAIG,UAAmB;MAEvB,OAAOxB,KAAI,CAACO,IAAI,CACd,UAAAf,KAAK;QACHgC,UAAU,GAAG,KAAK;QAClBH,GAAG,GAAG7B,KAAK;QACX,IAAI+B,SAAS,EAAE;UACbA,SAAS,EAAE;;MAEf,CAAC,EACD,UAAA3B,MAAM;QACJ4B,UAAU,GAAG,IAAI;QACjBH,GAAG,GAAGzB,MAAM;QACZ,IAAI2B,SAAS,EAAE;UACbA,SAAS,EAAE;;MAEf,CAAC,CACF,CAAChB,IAAI,CAAC;QACL,IAAIiB,UAAU,EAAE;UACd1B,MAAM,CAACuB,GAAG,CAAC;UACX;;QAGF3B,OAAO,CAAC2B,GAAqB,CAAC;MAChC,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ,CAAC;EAuDH,OAAA5B,WAAC;AAAD,CAAC,CAhJD;AAkJA,SAASA,WAAW"},"metadata":{},"sourceType":"module"}